{% extends "base.html" %}
{% block title %}Research{% endblock %}

{% block body %}
<div class="container">
  <h1>Stock Research</h1>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Enter stock symbol (e.g. AAPL)" />
    <button onclick="search()">Search</button>
  </div>

  <div id="quoteCard" class="card" style="display: none;">
    <h2 id="symbol"></h2>
    <p id="price"></p>
    <p id="change"></p>
    <p id="prevClose"></p>
  </div>

  <canvas id="priceChart" style="display: none; max-width: 100%; height: 300px;"></canvas>
</div>

<script>
  async function search() {
    const symbol = document.getElementById("searchInput").value.trim().toUpperCase();
    if (!symbol) return;

    const quoteRes = await fetch(`/api/quote?symbol=${symbol}`);
    const quote = await quoteRes.json();

    if (!quote.c) {
      alert("No data found.");
      return;
    }

    document.getElementById("symbol").innerText = symbol;
    document.getElementById("price").innerText = `Price: $${quote.c}`;
    document.getElementById("change").innerText = `Change: ${quote.d} (${quote.dp}%)`;
    document.getElementById("prevClose").innerText = `Previous Close: $${quote.pc}`;
    document.getElementById("quoteCard").style.display = "block";

    const chartRes = await fetch(`/api/chart?symbol=${symbol}`);
    const chartData = await chartRes.json();

    const labels = chartData.t.map(ts => new Date(ts * 1000).toLocaleDateString());
    const prices = chartData.c;

    const ctx = document.getElementById("priceChart").getContext("2d");
    document.getElementById("priceChart").style.display = "block";
    if (window.myChart) window.myChart.destroy();

    window.myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `${symbol} Closing Prices`,
          data: prices,
          borderColor: 'blue',
          backgroundColor: 'rgba(0, 0, 255, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: true },
          y: { beginAtZero: false }
        }
      }
    });
  }
</script>
{% endblock %}
