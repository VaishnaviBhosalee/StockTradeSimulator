{% extends "base.html" %}

{% block title %} Home {% endblock %}

{% block body %}
<h2 style="text-align: center;margin:50px;">HOME PAGE</h2>

<!-- ───────────────────── Account Overview ───────────────────── -->
<div class="dashboard-container">
  <div class="stats-card">
    <div class="stat">
      <h4>ACCOUNT VALUE</h4>
      <p class="value">${{ "{:,.2f}".format(account_value) }}</p>
    </div>
    <div class="stat">    
      <h4>TODAY'S CHANGE</h4>
      <p>
        <span class="{{ 'text-success' if todays_change >= 0 else 'text-danger' }}">
          ${{ "{:,.2f}".format(todays_change) }}
        </span>
      </p>
    </div>
  </div>

  <div class="chart-card">
    <h4>PERFORMANCE (1W)</h4>
    <canvas id="performanceChart"></canvas>
  </div>
</div>

<!-- ───────────────────── Holdings Table ───────────────────── -->
<div class="card mx-auto my-5 text-center" style="width: 80%;">
  <h5 class="card-title p-3">Holding</h5>
  <div class="card-body">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Symbol</th>
          <th>Description</th>
          <th>Purchase Price</th>
          <th>Qty</th>
          <th>Total Value</th>
          <th>Trade Actions</th>
          <th>Current Price</th>
          <th>Change</th>
          <th>% Change</th>

        </tr>
      </thead>
      <tbody>
        {% for stock in stocks if stock.status %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ stock.stock_symbol }}</td>
          <td>{{ stock.stock_name }}</td>
          <td>${{ "{:,.2f}".format(stock.buy_price_of_user) }}</td>
          <td>{{ stock.qty }}</td>
          <td>${{ "{:,.2f}".format(stock.total_value) }}</td>
          <td class="d-flex justify-content-center gap-2">

            <!-- Buy Form -->
            <form method="POST" action="/trade/{{ user_name }}/{{ login_success }}" class="d-inline-flex align-items-center gap-1">
              <input type="hidden" name="stock_symbol" value="{{ stock.stock_symbol }}">
              <input type="hidden" name="stock_name" value="{{ stock.stock_name }}">
              <input type="hidden" name="action" value="buy">
              <input type="number" name="qty" min="1" value="1" style="width: 60px;" required>
              <button type="submit" class="btn btn-success btn-sm">Buy</button>
            </form>

            <!-- Sell Form -->
            <form method="POST" action="/trade/{{ user_name }}/{{ login_success }}" class="d-inline-flex align-items-center gap-1">
              <input type="hidden" name="stock_symbol" value="{{ stock.stock_symbol }}">
              <input type="hidden" name="stock_name" value="{{ stock.stock_name }}">
              <input type="hidden" name="action" value="sell">
              <input type="number" name="qty" min="1" value="1" style="width: 60px;" required>
              <button type="submit" class="btn btn-danger btn-sm">Sell</button>
            </form>
            </td>

            <td id="price-{{ stock.stock_symbol }}">$0.00</td>
            <td id="change-{{ stock.stock_symbol }}">0.00</td>
            <td id="percent-{{ stock.stock_symbol }}">0.00%</td>


          
        </tr>
        {% else %}
        <tr><td colspan="10">No holdings found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ───────────────────── Chart.js Script ───────────────────── -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('performanceChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Wed', 'Thu', 'Fri', 'Sat', 'Sun', 'Mon', 'Tue'],
      datasets: [{
        label: 'Value',
        data: {{ performance_values | default([0, 0, 0, 0, 0, 0, 0]) | safe }},
        borderColor: '#00c8ff',
        backgroundColor: 'rgba(0, 200, 255, 0.2)',
        pointBackgroundColor: '#00c8ff',
        tension: 0.3
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
    async function fetchQuote(symbol) {
    const response = await fetch(`/api/quote?symbol=${symbol}`);
    const data = await response.json();

    if (data.error) {
      console.error("Error:", data.error);
    } else {
      document.getElementById(`price-${symbol}`).textContent = `$${data.c.toFixed(2)}`;
      document.getElementById(`change-${symbol}`).textContent = `${data.d.toFixed(2)}`;
      document.getElementById(`percent-${symbol}`).textContent = `${data.dp.toFixed(2)}%`;
    }
  }

  // Fetch every 10 seconds (adjust if needed)
  const symbols = {{ stocks | map(attribute='stock_symbol') | list | tojson }};
  setInterval(() => {
    symbols.forEach(symbol => fetchQuote(symbol));
  }, 10000);
</script>

{% endblock %}
